@model appMonumentos.Models.Monumento
@using System.Security.Claims

@{
    ViewData["Title"] = "Detalhes do Monumento";

    var imagemPrincipal = Model.Imagens?.FirstOrDefault(i => i.IsPrincipal);
    var imagensSecundarias = Model.Imagens?.Where(i => !i.IsPrincipal).ToList() ?? new List<appMonumentos.Models.Imagem>();

    var userAuthenticated = User.Identity?.IsAuthenticated ?? false;
    var currentUsername = User.Identity?.Name;
    var isAdmin = User.IsInRole("Admin");

    var userVisit = Model.VisitasMonumento?.FirstOrDefault(v => v.Utilizador.Username == currentUsername);
}

<h2>@Model.Designacao</h2>
<hr />

<!-- VISITAS -->
@if (userAuthenticated)
{
    @if (userVisit == null)
    {
        <form asp-action="MarcarVisita" method="post" style="display:inline;">
            <input type="hidden" name="id" value="@Model.Id" />
            <button type="submit" class="btn btn-primary">Marcar como visitado</button>
        </form>
    }
    else
    {
        <p>As suas visitas: <strong>@userVisit.NumeroVisitas</strong></p>

        <form asp-action="IncrementarVisita" method="post" style="display:inline;">
            <input type="hidden" name="id" value="@Model.Id" />
            <button type="submit" class="btn btn-success">+</button>
        </form>

        <form asp-action="DecrementarVisita" method="post" style="display:inline;">
            <input type="hidden" name="id" value="@Model.Id" />
            <button type="submit" class="btn btn-warning">-</button>
        </form>
    }

    <button class="btn btn-info mt-2" type="button" onclick="toggleListaVisitantes()">Mostrar/Esconder Lista de Visitantes</button>

    <div id="listaVisitantes" class="mt-2" style="display: none;">
        <h5>Utilizadores que visitaram:</h5>
        @if (Model.VisitasMonumento.Any())
        {
            <ul>
                @foreach (var visita in Model.VisitasMonumento)
                {
                    <li>@visita.Utilizador.Nome (@visita.NumeroVisitas visitas)</li>
                }
            </ul>
        }
        else
        {
            <p><i>Ainda ninguém marcou como visitado.</i></p>
        }
    </div>

    <script>
        function toggleListaVisitantes() {
            const div = document.getElementById("listaVisitantes");
            div.style.display = (div.style.display === "none") ? "block" : "none";
        }
    </script>
}
else
{
    <p><i>Inicie sessão para marcar visitas.</i></p>
}

<p>Total de visitas a este monumento: <strong>@(Model.VisitasMonumento?.Sum(v => v.NumeroVisitas) ?? 0)</strong></p>
<hr />

<!-- IMAGEM PRINCIPAL -->
<div style="margin-bottom: 30px;">
    <h4>Imagem Principal:</h4>
    @if (imagemPrincipal != null)
    {
        <img src="~/imagens/@imagemPrincipal.NomeImagem" alt="Imagem Principal" width="400" />

        @if (userAuthenticated && (imagemPrincipal.Utilizador?.Username == currentUsername || isAdmin))
        {
            <form asp-controller="Monumento" asp-action="DeleteImagem" method="post" asp-route-id="@imagemPrincipal.Id" onsubmit="return confirm('Tem a certeza que quer apagar esta imagem?');">
                <button type="submit" class="btn btn-danger btn-sm mt-2">Apagar imagem</button>
            </form>
        }

        <h5 class="mt-3">Comentários:</h5>
        @if (imagemPrincipal.Comentarios?.Any() == true)
        {
            <ul>
                @foreach (var comentario in imagemPrincipal.Comentarios.OrderByDescending(c => c.Data))
                {
                    <li>
                        <strong>@comentario.Utilizador?.Username</strong>
                        @(comentario.Utilizador?.Id == Model.Utilizador?.Id ? " (criador deste monumento)" : "")
                        : @comentario.ComentarioTexto
                        <br />
                        <small>@comentario.Data.ToString("dd/MM/yyyy HH:mm")</small>

                        @if (userAuthenticated && (comentario.Utilizador?.Username == currentUsername || isAdmin))
                        {
                            <form asp-controller="Comentario" asp-action="Delete" method="post" asp-route-id="@comentario.Id" class="d-inline">
                                <button type="submit" class="btn btn-danger btn-sm mt-1">Apagar</button>
                            </form>
                        }
                    </li>
                }
            </ul>
        }
        else { <p><i>Sem comentários.</i></p> }

        @if (userAuthenticated)
        {
            <form asp-controller="Comentario" asp-action="Criar" method="post">
                <input type="hidden" name="ImagemId" value="@imagemPrincipal.Id" />
                <div class="form-group">
                    <label for="ComentarioTexto">Comentário:</label>
                    <textarea name="ComentarioTexto" class="form-control" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary mt-2">Submeter</button>
            </form>
        }
    }
    else
    {
        <div style="width:400px; height:250px; background-color:lightgray; text-align:center; line-height:250px;">
            Sem imagem principal
        </div>
    }
</div>

<!-- UPLOAD IMAGEM -->
@if (userAuthenticated)
{
    <h4>Enviar nova imagem:</h4>
    @if (Model.Utilizador?.Username == currentUsername && imagemPrincipal == null)
    {
        <p><i>Como criador, esta será a principal.</i></p>
    }
    <form asp-action="UploadImagem" method="post" enctype="multipart/form-data">
        <input type="hidden" name="monumentoId" value="@Model.Id" />
        <input type="file" name="imagem" required />
        <button type="submit">Enviar Imagem</button>
    </form>
}

<!-- IMAGENS SECUNDÁRIAS -->
@if (imagensSecundarias.Any())
{
    <h4>Imagens dos Utilizadores:</h4>
    @foreach (var img in imagensSecundarias)
    {
        <div style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px;">
            <img src="~/imagens/@img.NomeImagem" alt="Imagem Secundária" width="300" />
            @if (userAuthenticated && (img.Utilizador?.Username == currentUsername || isAdmin))
            {
                <form asp-controller="Monumento" asp-action="DeleteImagem" method="post" asp-route-id="@img.Id" onsubmit="return confirm('Apagar esta imagem?');">
                    <button type="submit" class="btn btn-danger btn-sm mt-2">Apagar</button>
                </form>
            }

            <h5 class="mt-3">Comentários:</h5>
            @if (img.Comentarios?.Any() == true)
            {
                <ul>
                    @foreach (var comentario in img.Comentarios.OrderByDescending(c => c.Data))
                    {
                        <li>
                            <strong>@comentario.Utilizador?.Username</strong>
                            @(comentario.Utilizador?.Id == Model.Utilizador?.Id ? " (criador)" : "")
                            : @comentario.ComentarioTexto
                            <br />
                            <small>@comentario.Data.ToString("dd/MM/yyyy HH:mm")</small>
                        </li>
                    }
                </ul>
            }
            else { <p><i>Sem comentários.</i></p> }
        </div>
    }
}
